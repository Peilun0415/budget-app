<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>我的記帳本</title>
  <!-- 讀取畫面最早套用，不等外部 CSS 載入 -->
  <style>
    #splashScreen {
      position: fixed;
      inset: 0;
      background: #f0f6ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    #loginScreen, #appScreen { display: none; }
  </style>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>

  <!-- 讀取畫面 -->
  <div id="splashScreen" class="splash-screen">
    <div class="splash-logo">💳</div>
    <div class="splash-title">我的記帳本</div>
    <div class="splash-spinner"></div>
  </div>

  <!-- 登入畫面 -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">💳</div>
      <h1 class="login-title">我的記帳本</h1>
      <p class="login-desc">登入後可在手機與電腦<br>同步查看所有記帳資料</p>
      <button class="google-login-btn" id="googleLoginBtn">
        <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-3.59-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        使用 Google 帳號登入
      </button>

      <div class="login-divider"><span>或使用暱稱登入</span></div>

      <div class="guest-login-wrap">
        <!-- 登入 / 註冊 切換 -->
        <div class="guest-mode-tabs">
          <button class="guest-mode-tab active" id="guestTabLogin">登入</button>
          <button class="guest-mode-tab" id="guestTabRegister">註冊</button>
        </div>

        <div class="guest-fields">
          <input type="text" id="guestNameInput" class="guest-name-input" placeholder="暱稱（帳號）" maxlength="20" autocomplete="username" />
          <input type="password" id="guestPassInput" class="guest-name-input" placeholder="密碼（至少 6 位）" maxlength="30" autocomplete="current-password" />
        </div>

        <button class="guest-login-btn" id="guestLoginBtn">登入</button>
        <p class="guest-login-warn" id="guestLoginWarn"></p>
        <p class="guest-login-hint" id="guestLoginHint">用暱稱 + 密碼可在任何裝置登入，找回你的資料</p>
      </div>
    </div>
  </div>

  <!-- 主應用（登入後顯示） -->
  <div class="app-screen" id="appScreen" style="display:none">

    <!-- 頂部標題 -->
    <header class="app-header">
      <div class="header-title">
        <h1 id="pageTitle">我的記帳本</h1>
      </div>
      <div class="header-right">
        <img class="user-avatar" id="userAvatar" src="" alt="" />
        <button class="logout-btn" id="logoutBtn">登出</button>
      </div>
    </header>

    <!-- ===== 記帳頁面 ===== -->
    <div id="pageHome">
      <!-- 月份導覽 -->
      <div class="month-nav-bar" id="homeMonthNav">
        <button class="month-btn" id="prevMonth">‹</button>
        <span id="currentMonthLabel"></span>
        <button class="month-btn" id="nextMonth">›</button>
      </div>

      <!-- 統計卡片 -->
      <section class="summary-section" id="homeSummary">
        <div class="summary-card income-card">
          <div class="summary-icon">💰</div>
          <div class="summary-info">
            <span class="summary-label">本月收入</span>
            <span class="summary-amount" id="totalIncome">$0</span>
          </div>
        </div>
        <div class="summary-card expense-card">
          <div class="summary-icon">🛍️</div>
          <div class="summary-info">
            <span class="summary-label">本月支出</span>
            <span class="summary-amount" id="totalExpense">$0</span>
          </div>
        </div>
        <div class="summary-card balance-card">
          <div class="summary-icon">✨</div>
          <div class="summary-info">
            <span class="summary-label">結餘</span>
            <span class="summary-amount" id="totalBalance">$0</span>
          </div>
        </div>
      </section>

      <!-- 主頁預算小卡 -->
      <div id="homeBudgetWidget" style="display:none">
        <div class="home-budget-header">
          <span class="home-budget-title">📊 預算狀況</span>
          <button class="home-budget-more" id="homeBudgetMoreBtn">管理 ›</button>
        </div>
        <div id="homeBudgetContent"></div>
      </div>

      <!-- 新增按鈕 -->
      <div class="add-btn-wrap">
        <button class="add-btn" id="openFormBtn">＋ 新增記帳</button>
        <button class="voice-btn" id="voiceBtn" title="語音記帳">🎙️</button>
      </div>

      <!-- 語音辨識狀態提示 -->
      <div id="voiceToast" class="voice-toast" style="display:none">
        <div class="voice-toast-inner">
          <span class="voice-toast-dot"></span>
          <span id="voiceToastText">聆聽中…</span>
        </div>
      </div>

      <!-- 搜尋列 -->
      <div class="search-bar-wrap" id="searchBarWrap">
        <div class="search-input-wrap">
          <span class="search-icon">🔍</span>
          <input type="text" id="searchInput" class="search-input" placeholder="搜尋備註、分類、帳戶…" />
          <button class="search-clear-btn" id="searchClearBtn" style="display:none">✕</button>
        </div>
      </div>

      <!-- 記帳列表 -->
      <section class="list-section">
        <h2 class="list-title" id="listTitle">本月明細</h2>
        <div id="recordList" class="record-list">
          <div class="empty-state" id="emptyState">
            <span>📋</span>
            <p>還沒有記帳喔！<br>點上方按鈕開始記帳吧～</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== 帳戶頁面 ===== -->
    <div id="pageAccounts" style="display:none">
      <div class="accounts-header-bar">
        <div class="accounts-net-worth">
          <span class="accounts-net-label">淨資產</span>
          <span class="accounts-net-amount" id="accountsNetWorth">$0</span>
        </div>
        <div class="accounts-sub-stats">
          <div class="accounts-sub-item">
            <span class="accounts-sub-label">資產</span>
            <span class="accounts-sub-value asset" id="accountsTotalAsset">$0</span>
          </div>
          <div class="accounts-sub-divider"></div>
          <div class="accounts-sub-item">
            <span class="accounts-sub-label">負債</span>
            <span class="accounts-sub-value liability" id="accountsTotalLiability">$0</span>
          </div>
        </div>
      </div>

      <div class="add-btn-wrap">
        <button class="add-btn" id="openAccountFormBtn">＋ 新增帳戶</button>
      </div>

      <section class="list-section">
        <div id="accountList" class="account-list">
          <div class="empty-state" id="accountEmptyState">
            <span>🏦</span>
            <p>還沒有帳戶喔！<br>點上方按鈕新增帳戶吧～</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== 帳戶明細頁面 ===== -->
    <div id="pageAccountDetail" style="display:none">
      <!-- 帳戶資訊卡 -->
      <div class="account-detail-header">
        <button class="back-btn" id="backToAccountsBtn">‹ 返回</button>
        <div class="account-detail-info">
          <div class="account-detail-icon" id="detailIcon"></div>
          <div>
            <div class="account-detail-name" id="detailName"></div>
            <div class="account-detail-type" id="detailType"></div>
          </div>
        </div>
        <div class="account-detail-stats">
          <div class="detail-stat">
            <span class="detail-stat-label">期間收入</span>
            <span class="detail-stat-value income" id="detailIncome">$0</span>
          </div>
          <div class="detail-stat">
            <span class="detail-stat-label">期間支出</span>
            <span class="detail-stat-value expense" id="detailExpense">$0</span>
          </div>
          <div class="detail-stat detail-stat-balance">
            <span class="detail-stat-label">目前餘額</span>
            <span class="detail-stat-value balance" id="detailBalance">$0</span>
          </div>
        </div>
      </div>

      <!-- 時間範圍切換 -->
      <div class="detail-filter-bar">
        <div class="detail-mode-toggle">
          <button class="detail-mode-btn active" id="detailModeMonth">月份</button>
          <button class="detail-mode-btn" id="detailModeRange">自訂範圍</button>
          <button class="detail-mode-btn" id="detailModeAll">全部</button>
        </div>

        <!-- 月份模式 -->
        <div class="detail-month-nav" id="detailMonthNav">
          <button class="month-btn" id="detailPrevMonth">‹</button>
          <span id="detailMonthLabel"></span>
          <button class="month-btn" id="detailNextMonth">›</button>
        </div>

        <!-- 自訂範圍模式 -->
        <div class="detail-range-nav" id="detailRangeNav" style="display:none">
          <div class="range-row">
            <label>從</label>
            <input type="date" id="detailRangeStart" class="range-date-input" />
          </div>
          <div class="range-row">
            <label>到</label>
            <input type="date" id="detailRangeEnd" class="range-date-input" />
          </div>
        </div>
      </div>

      <!-- 明細列表 -->
      <section class="list-section">
        <h2 class="list-title" id="detailListTitle">本月明細</h2>
        <div id="accountDetailList" class="record-list">
          <div class="empty-state" id="accountDetailEmpty">
            <span>📋</span>
            <p>這個期間沒有記帳記錄</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== 分類管理頁面 ===== -->
    <div id="pageCategories" style="display:none">
      <div class="cat-mgmt-tabs">
        <button class="cat-mgmt-tab active" id="catTabExpense" data-type="expense">
          <span>💸</span> 支出
        </button>
        <button class="cat-mgmt-tab" id="catTabIncome" data-type="income">
          <span>💰</span> 收入
        </button>
      </div>
      <div class="add-btn-wrap">
        <button class="add-btn" id="openCatFormBtn">＋ 新增主分類</button>
      </div>
      <section class="list-section">
        <div id="categoryMgmtList" class="category-mgmt-list"></div>
      </section>
    </div>

    <!-- ===== 設定頁面 ===== -->
    <div id="pageSettings" style="display:none">
      <div class="settings-list">
        <button class="settings-item" id="goBudget">
          <span class="settings-item-icon">🎯</span>
          <div class="settings-item-info">
            <div class="settings-item-title">預算管理</div>
            <div class="settings-item-desc">設定每月總預算與各分類年度預算</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </button>
        <button class="settings-item" id="goRecurring">
          <span class="settings-item-icon">🔁</span>
          <div class="settings-item-info">
            <div class="settings-item-title">固定收支</div>
            <div class="settings-item-desc">設定每月薪資、房租等定期項目</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </button>
        <button class="settings-item" id="goCategories">
          <span class="settings-item-icon">🏷️</span>
          <div class="settings-item-info">
            <div class="settings-item-title">分類管理</div>
            <div class="settings-item-desc">新增、編輯、排序收支分類</div>
          </div>
          <span class="settings-item-arrow">›</span>
        </button>
        <button class="settings-item settings-item-danger" id="clearAllDataBtn">
          <span class="settings-item-icon">🗑️</span>
          <div class="settings-item-info">
            <div class="settings-item-title">清除所有資料</div>
            <div class="settings-item-desc">刪除所有記帳、帳戶、分類、範本、固定收支</div>
          </div>
        </button>
      </div>
    </div>

    <!-- ===== 預算管理頁面 ===== -->
    <div id="pageBudget" style="display:none">
      <!-- 月預算區塊 -->
      <div class="budget-section">
        <div class="budget-section-header">
          <span class="budget-section-title">💰 每月總預算</span>
          <button class="budget-edit-btn" id="editMonthBudgetBtn">編輯</button>
        </div>
        <div class="budget-month-card" id="budgetMonthCard">
          <div class="budget-month-empty" id="budgetMonthEmpty">尚未設定月預算</div>
          <div class="budget-month-info" id="budgetMonthInfo" style="display:none">
            <div class="budget-month-row">
              <span class="budget-month-label">本月支出</span>
              <span class="budget-month-vals">
                <span id="budgetMonthSpent">$0</span>
                <span class="budget-month-sep">/</span>
                <span id="budgetMonthLimit">$0</span>
              </span>
            </div>
            <div class="budget-progress-wrap">
              <div class="budget-progress-bar" id="budgetMonthBar"></div>
            </div>
            <div class="budget-month-pct" id="budgetMonthPct"></div>
          </div>
        </div>
      </div>

      <!-- 類別年預算區塊 -->
      <div class="budget-section">
        <div class="budget-section-header">
          <span class="budget-section-title">🏷️ 類別年度預算</span>
          <button class="budget-edit-btn" id="addCatBudgetBtn">＋ 新增</button>
        </div>
        <div id="catBudgetList" class="cat-budget-list">
          <div class="budget-empty" id="catBudgetEmpty">尚未設定類別預算</div>
        </div>
      </div>
    </div>

    <!-- 月預算編輯 modal -->
    <div class="modal-overlay" id="monthBudgetOverlay">
      <div class="modal">
        <div class="modal-header">
          <h2>每月總預算</h2>
          <button class="close-btn" id="closeMonthBudgetBtn">✕</button>
        </div>
        <div class="form-group">
          <label class="form-label">金額（元）</label>
          <input type="number" id="monthBudgetInput" class="form-input" placeholder="例：30000" min="0" />
        </div>
        <div class="modal-actions">
          <button class="btn-save" id="saveMonthBudgetBtn">儲存</button>
          <button class="btn-delete" id="deleteMonthBudgetBtn" style="display:none">刪除預算</button>
        </div>
      </div>
    </div>

    <!-- 類別預算編輯 modal -->
    <div class="modal-overlay" id="catBudgetOverlay">
      <div class="modal">
        <div class="modal-header">
          <h2 id="catBudgetModalTitle">新增類別預算</h2>
          <button class="close-btn" id="closeCatBudgetBtn">✕</button>
        </div>
        <div class="form-group">
          <label class="form-label">支出分類</label>
          <select id="catBudgetCatSelect" class="form-input"></select>
        </div>
        <div class="form-group">
          <label class="form-label">年度預算金額（元）</label>
          <input type="number" id="catBudgetAmtInput" class="form-input" placeholder="例：50000" min="0" />
        </div>
        <div class="modal-actions">
          <button class="btn-save" id="saveCatBudgetBtn">儲存</button>
          <button class="btn-delete" id="deleteCatBudgetBtn" style="display:none">刪除預算</button>
        </div>
      </div>
    </div>

    <!-- 清除資料確認彈窗 -->
    <div class="modal-overlay" id="clearDataOverlay">
      <div class="modal clear-data-modal">
        <div class="modal-header">
          <h2>清除所有資料</h2>
          <button class="close-btn" id="closeClearDataBtn">✕</button>
        </div>
        <p class="clear-data-warning">⚠️ 此操作將永久刪除你的所有記帳紀錄、帳戶、分類、範本及固定收支，<strong>無法復原</strong>。</p>
        <p class="clear-data-confirm-label">請輸入「確認刪除」以繼續：</p>
        <input type="text" id="clearDataConfirmInput" placeholder="確認刪除" class="form-select" />
        <div id="clearDataProgress" style="display:none" class="clear-data-progress">刪除中...</div>
        <div class="form-action-row" style="margin-top:16px">
          <button type="button" class="delete-record-btn" id="confirmClearDataBtn" style="flex:1">確認清除</button>
          <button type="button" class="submit-btn" id="cancelClearDataBtn">取消</button>
        </div>
      </div>
    </div>

    <!-- ===== 固定收支頁面 ===== -->
    <div id="pageRecurring" style="display:none">
      <div class="add-btn-wrap">
        <button class="add-btn" id="openRecurringFormBtn">＋ 新增固定項目</button>
      </div>
      <section class="list-section">
        <div id="recurringList" class="recurring-list"></div>
        <div class="empty-state" id="recurringEmpty" style="display:none">
          <span>🔁</span>
          <p>尚無固定收支<br>點上方按鈕新增</p>
        </div>
      </section>
    </div>

    <!-- ===== 報表頁面 ===== -->
    <div id="pageReport" style="display:none">

      <!-- Tab 切換 -->
      <div class="report-tabs">
        <button class="report-tab active" data-tab="category">類別分析</button>
        <button class="report-tab" data-tab="trend">收支趨勢</button>
      </div>

      <!-- ===== 類別分析 Tab ===== -->
      <div id="reportTabCategory" class="report-tab-content">
        <!-- 支出/收入 + 月/年切換（同一列） -->
        <div class="report-ctrl-bar">
          <div class="report-pill-group report-pill-group--main">
            <button class="report-pill active" id="reportTypeBtnExpense">支出</button>
            <button class="report-pill" id="reportTypeBtnIncome">收入</button>
          </div>
          <div class="report-pill-group">
            <button class="report-pill active" id="catViewBtnMonth">月</button>
            <button class="report-pill" id="catViewBtnYear">年</button>
          </div>
        </div>
        <!-- 月份選擇 -->
        <div class="report-period-bar" id="reportPeriodBarCat">
          <button class="month-btn" id="reportPrevMonth">‹</button>
          <span id="reportMonthLabel"></span>
          <button class="month-btn" id="reportNextMonth">›</button>
        </div>
        <!-- 圓餅圖 -->
        <div class="report-chart-wrap">
          <canvas id="categoryPieChart"></canvas>
          <div class="report-chart-empty" id="categoryChartEmpty" style="display:none">無資料</div>
        </div>
        <!-- 麵包屑導覽 -->
        <div class="report-breadcrumb" id="reportBreadcrumb" style="display:none">
          <button class="report-breadcrumb-back" id="reportBreadcrumbBack">‹ 返回</button>
          <span id="reportBreadcrumbLabel"></span>
        </div>
        <!-- 類別列表 -->
        <div id="reportCategoryList" class="report-category-list"></div>
      </div>

      <!-- ===== 收支趨勢 Tab ===== -->
      <div id="reportTabTrend" class="report-tab-content" style="display:none">
        <!-- 支出/收入/結餘切換 -->
        <div class="report-ctrl-bar">
          <div class="report-pill-group report-pill-group--main">
            <button class="report-pill active" id="trendMetaBtnExpense">支出</button>
            <button class="report-pill" id="trendMetaBtnIncome">收入</button>
            <button class="report-pill" id="trendMetaBtnBalance">結餘</button>
          </div>
        </div>
        <!-- 年份切換 -->
        <div class="report-period-bar" id="trendYearNav">
          <button class="month-btn" id="trendPrevYear">‹</button>
          <span id="trendYearLabel"></span>
          <button class="month-btn" id="trendNextYear">›</button>
        </div>
        <!-- 長條圖 -->
        <div class="report-chart-wrap" style="max-height:300px">
          <canvas id="trendBarChart"></canvas>
        </div>
        <!-- 年統計 -->
        <div class="trend-year-stats" id="trendYearStats"></div>
        <!-- 月份明細列表 -->
        <div class="trend-month-list" id="trendMonthList"></div>
      </div>
    </div>

    <!-- 底部導覽列 -->
    <nav class="bottom-nav">
      <button class="nav-btn active" id="navHome" data-page="home">
        <span class="nav-icon">📒</span>
        <span class="nav-label">記帳</span>
      </button>
      <button class="nav-btn" id="navAccounts" data-page="accounts">
        <span class="nav-icon">🏦</span>
        <span class="nav-label">帳戶</span>
      </button>
      <button class="nav-btn" id="navReport" data-page="report">
        <span class="nav-icon">📊</span>
        <span class="nav-label">報表</span>
      </button>
      <button class="nav-btn" id="navSettings" data-page="settings">
        <span class="nav-icon">⚙️</span>
        <span class="nav-label">設定</span>
      </button>
    </nav>

  </div><!-- /app-screen -->

  <!-- 新增/編輯記帳彈窗 -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="recordModalTitle">新增記帳</h2>
        <div class="modal-header-actions">
          <button type="button" class="tpl-apply-btn" id="openTplListBtn" title="套用範本">📋</button>
          <button class="close-btn" id="closeFormBtn">✕</button>
        </div>
      </div>

      <div class="type-toggle">
        <button class="type-btn active" id="btnExpense" data-type="expense">支出</button>
        <button class="type-btn" id="btnIncome" data-type="income">收入</button>
        <button class="type-btn" id="btnTransfer" data-type="transfer">轉帳</button>
      </div>

      <form id="recordForm">
        <div class="form-group">
          <label for="amount">金額</label>
          <div class="amount-row">
            <button type="button" class="cat-pick-btn" id="catPickBtn">
              <span id="catPickEmoji">📦</span>
              <span id="catPickName">選擇分類</span>
            </button>
            <div class="amount-input-wrap" id="amountInputWrap">
              <span class="currency-sign">$</span>
              <input type="text" id="amount" placeholder="0" inputmode="none" required />
              <button type="button" class="calc-toggle-btn" id="calcToggleBtn">🔢</button>
            </div>
          </div>
          <!-- 計算機顯示列 -->
          <div class="calc-expression" id="calcExpression"></div>
          <!-- 計算機鍵盤 -->
          <div class="calc-keyboard" id="calcKeyboard" style="display:none">
            <div class="calc-grid">
              <button type="button" class="calc-btn calc-fn" data-action="clear">C</button>
              <button type="button" class="calc-btn calc-fn" data-action="backspace">⌫</button>
              <button type="button" class="calc-btn calc-op" data-val="%">%</button>
              <button type="button" class="calc-btn calc-op" data-val="÷">÷</button>

              <button type="button" class="calc-btn" data-val="7">7</button>
              <button type="button" class="calc-btn" data-val="8">8</button>
              <button type="button" class="calc-btn" data-val="9">9</button>
              <button type="button" class="calc-btn calc-op" data-val="×">×</button>

              <button type="button" class="calc-btn" data-val="4">4</button>
              <button type="button" class="calc-btn" data-val="5">5</button>
              <button type="button" class="calc-btn" data-val="6">6</button>
              <button type="button" class="calc-btn calc-op" data-val="-">−</button>

              <button type="button" class="calc-btn" data-val="1">1</button>
              <button type="button" class="calc-btn" data-val="2">2</button>
              <button type="button" class="calc-btn" data-val="3">3</button>
              <button type="button" class="calc-btn calc-op" data-val="+">+</button>

              <button type="button" class="calc-btn" data-val="0">0</button>
              <button type="button" class="calc-btn" data-val=".">.</button>
              <button type="button" class="calc-btn calc-eq" data-action="equal" colspan="2">=</button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="date">日期</label>
          <input type="date" id="date" required />
        </div>

        <!-- 一般記帳：帳戶選擇 -->
        <div class="form-group" id="accountGroup">
          <label for="accountSelect">帳戶</label>
          <select id="accountSelect" class="form-select"></select>
        </div>

        <!-- 轉帳專用：從/到帳戶 -->
        <div id="transferGroup" style="display:none">
          <div class="transfer-accounts-row">
            <div class="form-group transfer-acc-group">
              <label for="transferFrom">從</label>
              <select id="transferFrom" class="form-select"></select>
            </div>
            <div class="transfer-arrow">→</div>
            <div class="form-group transfer-acc-group">
              <label for="transferTo">到</label>
              <select id="transferTo" class="form-select"></select>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="note">備註（選填）</label>
          <input type="text" id="note" placeholder="例：午餐、薪水..." maxlength="30" />
        </div>

        <input type="hidden" id="recordEditId" value="" />
        <div class="form-action-row">
          <button type="submit" class="submit-btn" id="submitBtn">記下來！</button>
          <button type="button" class="delete-record-btn" id="deleteRecordBtn" style="display:none">刪除</button>
        </div>
        <button type="button" class="save-tpl-btn" id="saveTplBtn">📌 儲存為範本</button>
      </form>
    </div>
  </div>

  <!-- 分類選擇彈窗 -->
  <div class="modal-overlay cat-picker-overlay" id="catPickerOverlay">
    <div class="modal cat-picker-modal">
      <div class="modal-header">
        <h2>選擇分類</h2>
        <button class="close-btn" id="closeCatPickerBtn">✕</button>
      </div>
      <div class="cat-picker-body">
        <div class="cat-picker-left" id="catPickerParents"></div>
        <div class="cat-picker-right" id="catPickerSubs"></div>
      </div>
    </div>
  </div>

  <!-- 範本列表彈窗 -->
  <div class="modal-overlay" id="tplListOverlay">
    <div class="modal tpl-list-modal">
      <div class="modal-header">
        <h2>套用範本</h2>
        <button class="close-btn" id="closeTplListBtn">✕</button>
      </div>
      <div class="tpl-tabs">
        <button class="tpl-tab active" data-type="expense">支出</button>
        <button class="tpl-tab" data-type="income">收入</button>
        <button class="tpl-tab" data-type="transfer">轉帳</button>
      </div>
      <div id="tplList" class="tpl-list"></div>
      <div id="tplEmpty" class="empty-state" style="display:none">此類型尚無範本</div>
    </div>
  </div>

  <!-- 範本命名彈窗 -->
  <div class="modal-overlay" id="tplNameOverlay">
    <div class="modal tpl-name-modal">
      <div class="modal-header">
        <h2>儲存為範本</h2>
        <button class="close-btn" id="closeTplNameBtn">✕</button>
      </div>
      <div class="form-group">
        <label for="tplNameInput">範本名稱</label>
        <input type="text" id="tplNameInput" placeholder="例：早餐、每月房租..." maxlength="20" />
      </div>
      <button type="button" class="submit-btn" id="confirmSaveTplBtn">儲存</button>
    </div>
  </div>

  <!-- 固定收支彈窗 -->
  <div class="modal-overlay" id="recurringModalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="recurringModalTitle">新增固定項目</h2>
        <button class="close-btn" id="closeRecurringFormBtn">✕</button>
      </div>
      <form id="recurringForm">
        <div class="type-toggle">
          <button type="button" class="type-btn active" id="recBtnExpense" data-type="expense">支出</button>
          <button type="button" class="type-btn" id="recBtnIncome" data-type="income">收入</button>
        </div>

        <div class="form-group">
          <label>名稱</label>
          <input type="text" id="recName" placeholder="例：房租、薪資..." maxlength="20" required />
        </div>

        <div class="form-group">
          <label>金額</label>
          <div class="amount-row">
            <button type="button" class="cat-pick-btn" id="recCatPickBtn">
              <span id="recCatPickEmoji">📦</span>
              <span id="recCatPickName">選擇分類</span>
            </button>
            <div class="amount-input-wrap" id="recAmountInputWrap">
              <span class="currency-sign">$</span>
              <input type="text" id="recAmount" placeholder="0" inputmode="none" required />
              <button type="button" class="calc-toggle-btn" id="recCalcToggleBtn">🔢</button>
            </div>
          </div>
          <div class="calc-expression" id="recCalcExpression"></div>
          <div class="calc-keyboard" id="recCalcKeyboard" style="display:none">
            <div class="calc-grid">
              <button type="button" class="calc-btn calc-fn" data-rec-action="clear">C</button>
              <button type="button" class="calc-btn calc-fn" data-rec-action="backspace">⌫</button>
              <button type="button" class="calc-btn calc-op" data-rec-val="%">%</button>
              <button type="button" class="calc-btn calc-op" data-rec-val="÷">÷</button>

              <button type="button" class="calc-btn" data-rec-val="7">7</button>
              <button type="button" class="calc-btn" data-rec-val="8">8</button>
              <button type="button" class="calc-btn" data-rec-val="9">9</button>
              <button type="button" class="calc-btn calc-op" data-rec-val="×">×</button>

              <button type="button" class="calc-btn" data-rec-val="4">4</button>
              <button type="button" class="calc-btn" data-rec-val="5">5</button>
              <button type="button" class="calc-btn" data-rec-val="6">6</button>
              <button type="button" class="calc-btn calc-op" data-rec-val="-">−</button>

              <button type="button" class="calc-btn" data-rec-val="1">1</button>
              <button type="button" class="calc-btn" data-rec-val="2">2</button>
              <button type="button" class="calc-btn" data-rec-val="3">3</button>
              <button type="button" class="calc-btn calc-op" data-rec-val="+">+</button>

              <button type="button" class="calc-btn" data-rec-val="0">0</button>
              <button type="button" class="calc-btn" data-rec-val=".">.</button>
              <button type="button" class="calc-btn calc-eq" data-rec-action="equal">=</button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="recAccount">帳戶</label>
          <select id="recAccount" class="form-select"></select>
        </div>

        <div class="form-group">
          <label>頻率</label>
          <div class="freq-row">
            <span>每</span>
            <input type="number" id="recFreqN" value="1" min="1" max="99" class="freq-n-input" />
            <select id="recFreqUnit" class="form-select freq-unit-select">
              <option value="day">天</option>
              <option value="week">週</option>
              <option value="month" selected>月</option>
              <option value="year">年</option>
            </select>
          </div>
        </div>

        <!-- 每週：選星期幾 -->
        <div class="form-group" id="recWeekdayGroup" style="display:none">
          <label>執行星期</label>
          <div class="weekday-picker" id="recWeekdayPicker">
            <button type="button" class="weekday-btn" data-day="1">一</button>
            <button type="button" class="weekday-btn" data-day="2">二</button>
            <button type="button" class="weekday-btn" data-day="3">三</button>
            <button type="button" class="weekday-btn" data-day="4">四</button>
            <button type="button" class="weekday-btn" data-day="5">五</button>
            <button type="button" class="weekday-btn" data-day="6">六</button>
            <button type="button" class="weekday-btn" data-day="0">日</button>
          </div>
        </div>

        <!-- 每月：選幾號 -->
        <div class="form-group" id="recMonthdayGroup" style="display:none">
          <label>每月幾號</label>
          <div class="monthday-picker" id="recMonthdayPicker"></div>
        </div>

        <!-- 每年：選月份和日期 -->
        <div class="form-group" id="recYeardayGroup" style="display:none">
          <label>每年幾月幾日</label>
          <div class="freq-row">
            <select id="recYearMonth" class="form-select">
              <option value="1">1 月</option><option value="2">2 月</option>
              <option value="3">3 月</option><option value="4">4 月</option>
              <option value="5">5 月</option><option value="6">6 月</option>
              <option value="7">7 月</option><option value="8">8 月</option>
              <option value="9">9 月</option><option value="10">10 月</option>
              <option value="11">11 月</option><option value="12">12 月</option>
            </select>
            <select id="recYearDay" class="form-select"></select>
          </div>
        </div>

        <input type="hidden" id="recStartDate" />

        <div class="form-group">
          <label for="recNote">備註（選填）</label>
          <input type="text" id="recNote" placeholder="備註..." maxlength="30" />
        </div>

        <input type="hidden" id="recEditId" value="" />
        <div class="form-action-row">
          <button type="submit" class="submit-btn" id="recSubmitBtn">儲存</button>
          <button type="button" class="delete-record-btn" id="recDeleteBtn" style="display:none">刪除</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 新增帳戶彈窗 -->
  <div class="modal-overlay" id="accountModalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="accountModalTitle">新增帳戶</h2>
        <button class="close-btn" id="closeAccountFormBtn">✕</button>
      </div>

      <form id="accountForm">
        <!-- 帳戶類型 -->
        <div class="form-group">
          <label>帳戶類型</label>
          <div class="account-type-grid" id="accountTypeGrid"></div>
        </div>

        <!-- 帳戶名稱 -->
        <div class="form-group">
          <label for="accountName">帳戶名稱</label>
          <input type="text" id="accountName" placeholder="例：玉山銀行、國泰世華..." maxlength="20" required />
        </div>

        <!-- 初始餘額 -->
        <div class="form-group">
          <label for="accountBalance">初始餘額（信用卡欠款請輸入負數，例：-5000）</label>
          <div class="amount-input-wrap">
            <span class="currency-sign">$</span>
            <input type="number" id="accountBalance" placeholder="0" inputmode="decimal" />
          </div>
        </div>

        <!-- 備註 -->
        <div class="form-group">
          <label for="accountNote">備註（選填）</label>
          <input type="text" id="accountNote" placeholder="例：主要薪轉帳戶..." maxlength="30" />
        </div>

        <input type="hidden" id="accountEditId" value="" />
        <button type="submit" class="submit-btn" id="accountSubmitBtn">儲存帳戶</button>
      </form>
    </div>
  </div>

  <!-- 分類編輯彈窗（主分類 / 子分類共用） -->
  <div class="modal-overlay" id="catModalOverlay">
    <div class="modal">
      <div class="modal-header">
        <h2 id="catModalTitle">新增主分類</h2>
        <button class="close-btn" id="closeCatFormBtn">✕</button>
      </div>
      <form id="catForm">
        <div class="form-group">
          <label>圖示（Emoji）</label>
          <input type="text" id="catEmoji" placeholder="例：🍜" maxlength="4" />
        </div>
        <div class="form-group">
          <label for="catName">名稱</label>
          <input type="text" id="catName" placeholder="例：飲食" maxlength="12" required />
        </div>
        <!-- 子分類時顯示：所屬主分類（唯讀） -->
        <div class="form-group" id="catParentGroup" style="display:none">
          <label>所屬主分類</label>
          <div id="catParentLabel" class="cat-parent-label"></div>
        </div>
        <input type="hidden" id="catEditId" value="" />
        <input type="hidden" id="catParentId" value="" />
        <input type="hidden" id="catIsParent" value="true" />
        <div class="form-action-row">
          <button type="submit" class="submit-btn" id="catSubmitBtn">儲存</button>
          <button type="button" class="delete-record-btn" id="deleteCatBtn" style="display:none">刪除</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
